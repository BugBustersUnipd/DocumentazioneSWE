<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer - BugBusters</title>
    <meta name="description" content="Visualizzatore PDF con glossario personalizzato">
    <link rel="icon" href="assets/Logo.jpg" type="image/jpeg">
    <meta name="theme-color" content="#0066cc">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #0066cc;
            --primary-blue-dark: #004d99;
            --white: #ffffff;
            --text-dark: #1a1a1a;
            --border-light: #d9d9d9;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
        }

        header {
            background: var(--white);
            padding: 15px 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-bottom: 3px solid var(--primary-blue);
        }

        .header-inner {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
        }

        .brand-text h1 {
            font-size: 1.5rem;
            color: var(--primary-blue);
            margin: 0;
        }

        .brand-text p {
            font-size: 0.85rem;
            color: #666;
            margin: 0;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .content-wrapper {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .viewer-header h2 {
            color: var(--primary-blue);
            font-size: 1.5rem;
        }

        .control-btn {
            background: var(--primary-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .control-btn:hover {
            background: var(--primary-blue-dark);
        }

        .viewer-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .pdf-viewer {
            flex: 1;
            border: 1px solid var(--border-light);
            background: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
        }

        .pdf-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .glossary-panel {
            width: 400px;
            border: 1px solid var(--border-light);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow-y: auto;
            display: none;
        }

        .glossary-panel.active {
            display: block;
        }

        .glossary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-blue);
        }

        .glossary-header h3 {
            color: var(--primary-blue);
            font-size: 1.3rem;
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .close-btn:hover {
            background: #f0f0f0;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .search-stats {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
        }

        .glossary-list {
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }

        .glossary-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 4px;
        }

        .glossary-item:hover {
            background: #f8f9fa;
        }

        .term-title {
            color: var(--primary-blue);
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .term-preview {
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }

        .term-detail {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .back-to-list {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .back-to-list:hover {
            background: #5a6268;
        }

        .term-definition {
            line-height: 1.8;
            color: var(--text-dark);
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .highlight {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 2px;
        }

        @media (max-width: 1024px) {
            .viewer-container {
                flex-direction: column;
            }

            .glossary-panel {
                width: 100%;
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .header-inner {
                flex-direction: column;
                gap: 10px;
            }

            .viewer-header {
                flex-direction: column;
                gap: 10px;
            }

            .viewer-header h2 {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-inner">
            <div class="brand">
                <img src="assets/Logo.jpg" alt="Logo BugBusters" class="logo">
                <div class="brand-text">
                    <h1>BugBusters</h1>
                    <p>PDF Viewer con Glossario</p>
                </div>
            </div>
            <a href="index.html" class="back-btn">‚Üê Torna alla Home</a>
        </div>
    </header>

    <div class="content-wrapper">
        <div class="viewer-header">
            <h2 id="pdf-title">Caricamento PDF...</h2>
            <button id="toggle-glossary-btn" class="control-btn">üìö Mostra Glossario</button>
        </div>

        <div class="viewer-container">
            <div class="pdf-viewer">
                <iframe id="pdf-iframe" class="pdf-iframe" title="PDF Document"></iframe>
            </div>

            <div class="glossary-panel" id="glossary-panel">
                <div class="glossary-header">
                    <h3>üìö Glossario</h3>
                    <button id="close-glossary" class="close-btn" title="Chiudi glossario">√ó</button>
                </div>
                <div id="glossary-content">
                    <p style="color: #666; font-style: italic; text-align: center; padding: 20px;">
                        Caricamento glossario...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let glossaryData = [];
        let currentView = 'list'; // 'list' or 'detail'

        // Funzione per normalizzare il testo (rimuove accenti e converte in minuscolo)
        function normalizeText(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .trim();
        }

        // Funzione per evidenziare il testo corrispondente alla ricerca
        function highlightText(text, searchTerm) {
            if (!searchTerm) return text;
            
            const normalizedSearch = normalizeText(searchTerm);
            const normalizedText = normalizeText(text);
            
            if (!normalizedText.includes(normalizedSearch)) return text;
            
            // Trova la posizione nel testo originale
            const regex = new RegExp(searchTerm.split('').join('[\\u0300-\\u036f]*'), 'gi');
            return text.replace(regex, match => `<span class="highlight">${match}</span>`);
        }

        async function loadGlossary() {
            try {
                const response = await fetch('glossario.json?v=' + new Date().getTime());
                if (!response.ok) {
                    throw new Error('Errore nel caricamento del file');
                }
                const data = await response.json();
                glossaryData = data.terms || [];
                console.log('Glossario caricato:', glossaryData.length, 'termini');
                
                // Ordina alfabeticamente
                glossaryData.sort((a, b) => a.term.localeCompare(b.term, 'it'));
                
                showGlossaryList();
            } catch (error) {
                console.error('Errore nel caricamento del glossario:', error);
                document.getElementById('glossary-content').innerHTML = 
                    '<p style="color: #dc3545; text-align: center; padding: 20px;">Errore nel caricamento del glossario</p>';
            }
        }

        function showGlossaryList(searchTerm = '') {
            currentView = 'list';
            const content = document.getElementById('glossary-content');
            
            let filteredTerms = glossaryData;
            
            if (searchTerm) {
                const normalizedSearch = normalizeText(searchTerm);
                filteredTerms = glossaryData.filter(term => {
                    const normalizedTerm = normalizeText(term.term);
                    const normalizedDef = normalizeText(term.definition);
                    return normalizedTerm.includes(normalizedSearch) || 
                           normalizedDef.includes(normalizedSearch);
                });
            }
            
            let html = `
                <div class="search-box">
                    <input 
                        type="text" 
                        id="glossary-search" 
                        class="search-input" 
                        placeholder="Cerca nel glossario..." 
                        value="${searchTerm}"
                        autofocus
                    >
                    <div class="search-stats">
                        ${filteredTerms.length} ${filteredTerms.length === 1 ? 'termine trovato' : 'termini trovati'}
                        ${searchTerm ? ` per "${searchTerm}"` : ''}
                    </div>
                </div>
            `;
            
            if (filteredTerms.length === 0) {
                html += `
                    <div class="no-results">
                        <p>Nessun termine trovato per "${searchTerm}"</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Prova con una ricerca diversa</p>
                    </div>
                `;
            } else {
                html += '<div class="glossary-list">';
                filteredTerms.forEach(term => {
                    const highlightedTerm = highlightText(term.term, searchTerm);
                    const preview = term.definition.substring(0, 150);
                    const highlightedPreview = highlightText(preview, searchTerm);
                    
                    html += `
                        <div class="glossary-item" onclick="showTermDetail('${term.term.replace(/'/g, "\\'")}')">
                            <div class="term-title">${highlightedTerm}</div>
                            <div class="term-preview">
                                ${highlightedPreview}${term.definition.length > 150 ? '...' : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            content.innerHTML = html;
            
            // Aggiungi event listener per la ricerca
            const searchInput = document.getElementById('glossary-search');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    showGlossaryList(e.target.value);
                });
                
                // Focus sull'input se presente un termine di ricerca
                if (searchTerm) {
                    searchInput.focus();
                    searchInput.setSelectionRange(searchTerm.length, searchTerm.length);
                }
            }
        }

        function showTermDetail(termName) {
            currentView = 'detail';
            const term = glossaryData.find(t => t.term === termName);
            if (!term) return;
            
            const content = document.getElementById('glossary-content');
            content.innerHTML = `
                <div class="term-detail">
                    <button class="back-to-list" onclick="showGlossaryList()">
                        ‚Üê Torna alla lista
                    </button>
                    <h4 style="color: var(--primary-blue); font-size: 1.3rem; margin-bottom: 15px;">
                        ${term.term}
                    </h4>
                    <div class="term-definition">
                        ${term.definition}
                    </div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const pdfPath = urlParams.get('pdf');
            const pdfTitle = urlParams.get('title') || 'Documento PDF';

            if (!pdfPath) {
                document.getElementById('pdf-title').textContent = 'Errore: PDF non specificato';
                return;
            }

            document.getElementById('pdf-title').textContent = pdfTitle;

            // Carica il PDF
            const pdfIframe = document.getElementById('pdf-iframe');
            pdfIframe.src = pdfPath;

            // Carica il glossario
            loadGlossary();

            // Gestione toggle glossario
            const toggleBtn = document.getElementById('toggle-glossary-btn');
            const glossaryPanel = document.getElementById('glossary-panel');
            
            toggleBtn.addEventListener('click', function() {
                const isActive = glossaryPanel.classList.toggle('active');
                this.textContent = isActive ? 'üìö Nascondi Glossario' : 'üìö Mostra Glossario';
            });

            // Gestione chiusura glossario
            document.getElementById('close-glossary').addEventListener('click', function() {
                glossaryPanel.classList.remove('active');
                toggleBtn.textContent = 'üìö Mostra Glossario';
            });
        });

        // Esponi le funzioni globalmente per gli onclick inline
        window.showGlossaryList = showGlossaryList;
        window.showTermDetail = showTermDetail;
    </script>
</body>
</html>